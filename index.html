<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nối từ tiếng Nhật 3 cột</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #svgLayer {
      position: absolute;
      left: 0;
      top: 0;
      pointer-events: none;
      overflow: visible;
    }
    .word-box {
      user-select: none;
      transition: all 0.2s ease;
    }
  </style>
</head>
<body class="bg-gradient-to-b from-indigo-100 via-white to-pink-50 min-h-screen flex items-start justify-center p-6">
  <div class="max-w-6xl w-full">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-extrabold text-indigo-700">🔗 Nối từ - Kanji / Kana / Nghĩa</h1>
      <div class="space-x-3">
        <button id="shuffleBtn" class="bg-amber-400 hover:bg-amber-500 text-white px-3 py-2 rounded-lg">🔀 Shuffle</button>
        <button id="resetBtn" class="bg-red-400 hover:bg-red-500 text-white px-3 py-2 rounded-lg">♻️ Reset</button>
        <button id="revealBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg">👀 Show Answers</button>
      </div>
    </header>

    <main class="relative bg-white shadow-2xl rounded-2xl p-6 overflow-hidden">
      <svg id="svgLayer" width="100%" height="100%"></svg>

      <div class="grid grid-cols-3 gap-8 items-start">
        <div id="kanjiCol" class="space-y-3">
          <p class="text-sm text-gray-500 mb-2 font-medium text-center">Kanji</p>
        </div>
        <div id="kanaCol" class="space-y-3">
          <p class="text-sm text-gray-500 mb-2 font-medium text-center">Kana (Katakana/Hiragana)</p>
        </div>
        <div id="vietCol" class="space-y-3">
          <p class="text-sm text-gray-500 mb-2 font-medium text-center">Nghĩa tiếng Việt</p>
        </div>
      </div>
    </main>

    <footer class="mt-4 text-sm text-gray-500 text-center">
      Hướng dẫn: Click Kanji → Kana → Nghĩa để nối. Mỗi lần đúng mũi tên sẽ sáng xanh 💚
    </footer>
  </div>

  <script>
    let data = [];
    let kanjiItems = [], kanaItems = [], vietItems = [];
    let connections = [];
    let selectedKanji = null, selectedKana = null;

    const kanjiCol = document.getElementById('kanjiCol');
    const kanaCol = document.getElementById('kanaCol');
    const vietCol = document.getElementById('vietCol');
    const svgLayer = document.getElementById('svgLayer');

    const shuffleBtn = document.getElementById('shuffleBtn');
    const resetBtn = document.getElementById('resetBtn');
    const revealBtn = document.getElementById('revealBtn');

    const uid = (p='id') => p + Math.random().toString(36).slice(2,9);
    const shuffle = (a) => a.sort(() => Math.random() - 0.5);

    async function loadWords() {
      const res = await fetch("words.json?nocache=" + new Date().getTime());
      data = await res.json();
      init();
    }

    function init() {
      kanjiItems = data.map(p => ({ id: uid('K'), text: p.kanji }));
      kanaItems = shuffle(data).map(p => ({ id: uid('A'), text: p.kana }));
      vietItems = shuffle(data).map(p => ({ id: uid('V'), text: p.viet }));
      renderColumns();
    }

    function renderColumns() {
      [kanjiCol, kanaCol, vietCol].forEach(c => c.querySelectorAll('.word-box').forEach(n => n.remove()));
      svgLayer.innerHTML = '';
      connections = [];
      selectedKanji = null; selectedKana = null;

      kanjiItems.forEach(item => {
        const box = document.createElement('div');
        box.className = "word-box bg-indigo-50 border border-indigo-200 hover:shadow-md rounded-xl p-3 text-center cursor-pointer text-lg font-semibold text-indigo-700";
        box.textContent = item.text;
        box.onclick = () => selectKanji(item, box);
        item.el = box;
        kanjiCol.appendChild(box);
      });

      kanaItems.forEach(item => {
        const box = document.createElement('div');
        box.className = "word-box bg-blue-50 border border-blue-200 hover:shadow-md rounded-xl p-3 text-center cursor-pointer text-lg font-semibold text-blue-700";
        box.textContent = item.text;
        box.onclick = () => selectKana(item, box);
        item.el = box;
        kanaCol.appendChild(box);
      });

      vietItems.forEach(item => {
        const box = document.createElement('div');
        box.className = "word-box bg-rose-50 border border-rose-200 hover:shadow-md rounded-xl p-3 text-center cursor-pointer text-lg font-semibold text-rose-700";
        box.textContent = item.text;
        box.onclick = () => selectViet(item, box);
        item.el = box;
        vietCol.appendChild(box);
      });
    }

    function selectKanji(item, el) {
      kanjiCol.querySelectorAll('.word-box').forEach(b => b.classList.remove('ring-4','ring-indigo-300'));
      el.classList.add('ring-4','ring-indigo-300');
      selectedKanji = item;
      selectedKana = null;
    }

    function selectKana(item, el) {
      if (!selectedKanji) return;
      kanaCol.querySelectorAll('.word-box').forEach(b => b.classList.remove('ring-4','ring-blue-300'));
      el.classList.add('ring-4','ring-blue-300');
      selectedKana = item;
    }

    function selectViet(item, el) {
      if (!selectedKanji || !selectedKana) return;

      const conn = { id: uid('C'), kanji: selectedKanji, kana: selectedKana, viet: item, status: 'neutral' };
      connections.push(conn);
      drawConnection(conn);
      evaluateConnection(conn);

      [kanjiCol, kanaCol].forEach(c => c.querySelectorAll('.word-box').forEach(b => b.classList.remove('ring-4','ring-indigo-300','ring-blue-300')));
      selectedKanji = null;
      selectedKana = null;
    }

    function getCoords(el) {
      const rect = el.getBoundingClientRect();
      const svgRect = svgLayer.getBoundingClientRect();
      return { x: rect.left + rect.width / 2 - svgRect.left, y: rect.top + rect.height / 2 - svgRect.top };
    }

    function drawConnection(conn) {
      const l = getCoords(conn.kanji.el);
      const m = getCoords(conn.kana.el);
      const r = getCoords(conn.viet.el);

      const pathD = `M ${l.x} ${l.y} C ${l.x + 80} ${l.y} ${m.x - 80} ${m.y} ${m.x} ${m.y}
                     M ${m.x} ${m.y} C ${m.x + 80} ${m.y} ${r.x - 80} ${r.y} ${r.x} ${r.y}`;

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute('d', pathD);
      path.setAttribute('stroke', '#9CA3AF');
      path.setAttribute('stroke-width', '6');
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke-linecap','round');
      svgLayer.appendChild(path);
      conn.svgPath = path;
    }

    function evaluateConnection(conn) {
      const correct = data.find(p => p.kanji === conn.kanji.text);
      const isRight = correct && correct.kana === conn.kana.text && correct.viet === conn.viet.text;
      conn.status = isRight ? 'correct' : 'wrong';
      updateColor(conn);
    }

    function updateColor(conn) {
      if (!conn.svgPath) return;
      const color = conn.status === 'correct' ? '#16A34A' : '#DC2626';
      conn.svgPath.setAttribute('stroke', color);
      conn.svgPath.setAttribute('stroke-width', '8');
    }

    shuffleBtn.onclick = () => init();
    resetBtn.onclick = () => renderColumns();
    revealBtn.onclick = () => showAnswers();

    function showAnswers() {
      svgLayer.innerHTML = '';
      connections = [];
      data.forEach(row => {
        const k = kanjiItems.find(i => i.text === row.kanji);
        const a = kanaItems.find(i => i.text === row.kana);
        const v = vietItems.find(i => i.text === row.viet);
        if (!k || !a || !v) return;
        const conn = { id: uid('C'), kanji: k, kana: a, viet: v, status: 'correct' };
        connections.push(conn);
        drawConnection(conn);
        updateColor(conn);
      });
    }

    loadWords();
  </script>
</body>
</html>
